window.CKEDITOR.focusManager.prototype.blur=window.CKEDITOR.focusManager.prototype.forceBlur;ckez.CKeditor=zk.$extends(zul.Widget,{_height:"200",_value:"",$define:{value:[function(a){return !a?"":a},function(a){var b=this.getEditor();if(b){b.setData(a)}}],autoHeight:null,filebrowserBrowseUrl:null,filebrowserImageBrowseUrl:null,filebrowserFlashBrowseUrl:null,customConfigurationsPath:_zkf=function(){if(this.desktop){this.rerender()}},toolbar:_zkf,width:function(a){if(!a||!this.$n()){return}this._setSize(jq("#cke_"+this.uuid+"-cnt"),a,"width")},height:function(a){if(!a||!this.$n()){return}this._setSize(jq("td#cke_contents_"+this.uuid+"-cnt"),a,"height")}},redraw:function(a){a.push("<div",this.domAttrs_({domStyle:true}),'><textarea id="',this.uuid,'-cnt">',this._value,"</textarea></div>")},domAttrs_:function(b){var a=this.$supers("domAttrs_",arguments);if(!this.isVisible()&&(!b||!b.visible)){a+=' style="display:none;"'}return a},bind_:function(){this.$supers("bind_",arguments);var a=this;setTimeout(function(){a._init()},50);zWatch.listen({onSend:this});zWatch.listen({onRestore:this})},unbind_:function(){if(!this._editor){this._unbind=true;this._arguments=arguments;return}this._editor.destroy(true);this._unbind=this._editor=null;zWatch.unlisten({onSend:this});zWatch.unlisten({onRestore:this});this.$supers("unbind_",arguments)},onSend:function(c){var a=c.args[1];if(!a){var b=this.getEditor();if(b){this.$class.onBlur(b,true)}}},onRestore:function(){var a=jq("td#cke_contents_"+this.uuid+"-cnt iframe")[0];if(!a){return}CKEDITOR.remove(this._editor);jq(this.$n()).html('<textarea id="'+this.uuid+'-cnt">'+this._value+"</textarea>");this.clearCache();this._init();if(zk.ie){jq("#cke_"+this.uuid+"-cnt").width(jq("#cke_"+this.uuid+"-cnt").width())}},_setSize:function(a,b,c){b=this._getValue(b);if(!b){return}a[c](b);this._editor.config[c]=b},_getValue:function(a){if(!a){return null}if(a.endsWith("%")){return zk.ie?jq.px0(jq(this.$n()).width()):a}return jq.px0(zk.parseInt(a))},getEditor:function(){return this._editor},_init:function(){var g=this,f=this._customConfigurationsPath,d=this._filebrowserBrowseUrl,a=this._filebrowserImageBrowseUrl,c=this._filebrowserFlashBrowseUrl,e="/web/ckez/html/browse.zul",b={customConfig:f,width:this._getValue(this._width),height:this._getValue(this._height)};if(d){b.filebrowserBrowseUrl=(typeof d=="string")?d:zk.ajaxURI(e+"?Type=Files",{desktop:this.desktop,au:true})}if(a){b.filebrowserImageBrowseUrl=(typeof a=="string")?a:zk.ajaxURI(e+"?Type=Flash",{desktop:this.desktop,au:true})}if(c){b.filebrowserFlashBrowseUrl=(typeof c=="string")?c:zk.ajaxURI(e+"?Type=Images",{desktop:this.desktop,au:true})}if(this._toolbar){b.toolbar=this._toolbar}jq(this.$n("cnt")).ckeditor(function(){if(g._unbind){this.destroy();g.unbind=g._editor=null;zWatch.unlisten({onSend:g});zWatch.unlisten({onRestore:g});g.$supers("unbind_",g._arguments);return}g._editor=this;this.on("focus",ckez.CKeditor.onFocus);this.on("blur",ckez.CKeditor.onBlur);this.on("selectionChange",ckez.CKeditor.onSelection);g._overrideFormSubmit();this.on("key",ckez.CKeditor.onAutoHeight);this.on("loadSnapshot",ckez.CKeditor.onAutoHeight);this.on("beforePaste",ckez.CKeditor.onAutoHeight);this.resetDirty()},b)},_overrideFormSubmit:function(){var b=this.getEditor(),d=zk.Widget.$(b.element.getId()),a=b.element,c=a.$.form&&new CKEDITOR.dom.element(a.$.form);if(!c){return}c.$.submit=CKEDITOR.tools.override(c.$.submit,function(e){return function(){b.updateElement();var f=b.getData();d.fire("onChange",{value:f},{sendAhead:true});d.fire("onSave",{value:f},{sendAhead:true})}})}},{onFocus:function(c){var b=c.editor,d=zk.Widget.$(b.element.getId()),a=b._.previousValue;d._tidChg=setInterval(function(){if(a!=b._.previousValue){a=d.previousValue=b._.previousValue}if(b.mayBeDirty&&d.previousValue!=b.getData()){d.fire("onChanging",{value:b.getData(),start:0,bySelectBack:false},{ignorable:1},100);if(b.mayBeDirty){d.previousValue=b.getData()}}},500)},onBlur:function(c,a){var b=c.editor?c.editor:c,e=zk.Widget.$(b.element.getId());if(e._tidChg){clearInterval(e._tidChg);e._tidChg=null}if(b.checkDirty()){var d=b.getData();e._value=d;e.fire("onChange",{value:d},{sendAhead:a});b.resetDirty()}},onSelection:function(c){var b=c.editor,d=zk.Widget.$(b.element.getId()),a=b.getSelection();if(!zk(d).isRealVisible){return}a=CKEDITOR.env.ie?a.getNative().createRange().text:a.getNative().toString();if(a==""){return}},onAutoHeight:function(d){var c=d.editor,f=zk.Widget.$(c.element.getId()),g=jq("td#cke_contents_"+f.uuid+"-cnt"),b=jq("td#cke_contents_"+f.uuid+"-cnt iframe"),a=b.contents().find("body"),e=zk.parseInt(c.config.height);if(f._autoHeight){setTimeout(function(){var h=zk.parseInt(a.find("P").css("marginBottom")),i=zk.parseInt(a.css("marginBottom"));g.height(a.height()+h+i);if(g.height()<e){g.height(e)}},20)}}});